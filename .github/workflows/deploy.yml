deploy:
  needs: test
  runs-on: ubuntu-latest
  steps:
    - name: Deploy to DigitalOcean Droplet
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script_stop: true
        script: |
          set -euo pipefail

          cd /var/www/myaccounts

          # --- Keep your PM2 ecosystem config safe ---
          if [ -f ecosystem.config.js ]; then
            cp ecosystem.config.js /tmp/ecosystem.config.js
          fi

          # --- Make repo EXACTLY match origin/main (fixes package-lock drift) ---
          git fetch origin main
          git reset --hard origin/main
          git clean -fd -e ecosystem.config.js

          # Restore ecosystem config (server-specific)
          if [ -f /tmp/ecosystem.config.js ]; then
            mv /tmp/ecosystem.config.js ecosystem.config.js
          fi

          # Locally ignore it so it never blocks pulls
          grep -qxF "ecosystem.config.js" .git/info/exclude || echo "ecosystem.config.js" >> .git/info/exclude

          # --- Install deps WITHOUT rewriting package-lock ---
          npm ci --legacy-peer-deps

          # Prisma generate (you already do this) :contentReference[oaicite:1]{index=1}
          npx prisma generate

          export NODE_OPTIONS="--max-old-space-size=5096"
          npm run build

          # Use ecosystem config to (re)load PM2 apps
          pm2 startOrReload ecosystem.config.js --update-env
