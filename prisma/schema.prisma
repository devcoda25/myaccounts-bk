generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Core
model User {
  id           String  @id @default(uuid())
  email        String  @unique
  firstName    String?
  otherNames   String?
  inviteCode   String?
  phoneNumber  String?
  passwordHash String?

  // Profile
  dob         DateTime?
  country     String?
  avatarUrl   String?
  role        String    @default("USER") // e.g., "SUPER_ADMIN", "ADMIN", "USER"
  preferences Json? // User settings (theme, notifications, etc.)
  lastLocation Json? // Store last detected location (country, city, coords)

  emailVerified    Boolean @default(false)
  phoneVerified    Boolean @default(false)
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String? // Encrypted TOTP secret
  recoveryCodes    String[] // Hashed recovery codes


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  credentials    UserCredential[]
  contacts       UserContact[]
  sessions       Session[]
  notifications  Notification[]
  auditLogs      AuditLog[]
  kyc            Kycrecord?
  consents       OAuthConsent[]
  appMemberships AppMembership[] // Relation to App Perms

  // Parental Control Relations
  ownedHousehold       Household?        @relation("HouseholdOwner")
  householdMemberships HouseholdMember[]
  supervisedChildren   ChildProfile[]    @relation("GuardianToChildren")

  // Developer Relations
  ownedClients OAuthClient[] @relation("ClientOwner")

  // Organization Relations
  orgMemberships OrganizationMember[]

  @@map("users")
}

model UserContact {
  id           String  @id @default(uuid())
  userId       String
  type         String // "EMAIL", "PHONE"
  label        String // "Personal", "Work", "Other"
  value        String
  verified     Boolean @default(false)
  isPrimary    Boolean @default(false)
  capabilities Json? // { login: boolean, sms: boolean, whatsapp: boolean }

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime?

  @@map("user_contacts")
}

// Multi-Authentication Methods (Social, Enterprise, etc.)
model UserCredential {
  id           String  @id @default(uuid())
  userId       String
  providerType String // "password", "google", "saml"
  providerId   String // external ID or same as email for password
  secretHash   String? // password hash or token
  metadata     Json? // e.g., profile data from provider

  user User @relation(fields: [userId], references: [id])

  @@unique([providerType, providerId])
  @@map("user_credentials")
}

// Organizations (Tenants)
model Organization {
  id          String   @id @default(uuid())
  name        String
  domain      String?  @unique // For enterprise SSO discovery
  type        String   @default("individual") // "enterprise", "provider", "individual"
  config      Json?    // SAML/OIDC federation settings, branding
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     OrganizationMember[]
  clients     OAuthClient[] @relation("OrgClients")

  @@map("organizations")
}

model OrganizationMember {
  id        String   @id @default(uuid())
  userId    String
  orgId     String
  role      String   @default("Member") // "Owner", "Admin", "Member"
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  joinedAt  DateTime @default(now())

  @@unique([userId, orgId])
  @@map("organization_members")
}

// OIDC Clients (EVzone Services)
model OAuthClient {
  id               String   @id @default(uuid()) // client_id
  clientId         String   @unique
  clientSecretHash String? // for confidential clients
  name             String
  website          String? // App Homepage/Domain
  redirectUris     String[]
  post_logout_redirect_uris String[] @default([])
  grantTypes       String[] // "authorization_code", "refresh_token"
  isPublic         Boolean  @default(false)
  isFirstParty     Boolean  @default(true) // skip consent if true
  id_token_signed_response_alg String @default("RS256")

  sessions Session[]
  consents OAuthConsent[]

  // Ownership: Can be owned by a User (Dev) OR an Organization (Tenant App)
  ownerId String?
  owner   User?   @relation("ClientOwner", fields: [ownerId], references: [id])
  
  orgId   String?
  organization Organization? @relation("OrgClients", fields: [orgId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      AppMembership[] // Relation to App Team

  @@map("oauth_clients")
}

// -----------------------------------------------------------------------------
// App RBAC (5-Tier Support)
// -----------------------------------------------------------------------------

enum AppRole {
  SUPER_APP_ADMIN
  REGIONAL_ADMIN
  STAFF
}

model AppMembership {
  id        String   @id @default(uuid())
  userId    String
  clientId  String
  role      AppRole
  region    String?  // For REGIONAL_ADMIN (e.g., "East Africa")
  permissions Json?  // Optional fine-grained overrides

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client    OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, clientId])
  @@map("app_memberships")
}

// ApiKey model removed

// Sessions & Refresh Tokens
model Session {
  id               String   @id @default(uuid())
  userId           String
  clientId         String?
  refreshTokenHash String?  @unique
  expiresAt        DateTime
  deviceInfo       Json? // IP, UserAgent
  passkeyChallenge String? // For WebAuthn challenge verification (stateful)


  user   User         @relation(fields: [userId], references: [id])
  client OAuthClient? @relation(fields: [clientId], references: [id])

  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@map("sessions")
}

model AuthCode {
  code                String   @id @unique
  clientId            String
  userId              String
  redirectUri         String
  codeChallenge       String
  codeChallengeMethod String   @default("S256")
  expiresAt           DateTime
  used                Boolean  @default(false)

  createdAt DateTime @default(now())

  @@map("auth_codes")
}

model VerificationRequest {
  id         String   @id @default(uuid())
  identifier String // email or phone
  token      String // OTP or hash
  type       String // "EMAIL_VERIFY", "PASSWORD_RESET"
  expiresAt  DateTime
  attempts   Int      @default(0)
  createdAt  DateTime @default(now())

  @@unique([identifier, type, token])
  @@map("verification_requests")
}

// -----------------------------------------------------------------------------
// Wallet Module
// -----------------------------------------------------------------------------

// Wallet Module removed

// Transaction model removed

// PaymentMethod model removed

// Dispute model removed

// DisputeEvidence model removed

// -----------------------------------------------------------------------------
// Compliance & Audit
// -----------------------------------------------------------------------------

model Kycrecord {
  id        String  @id @default(uuid())
  userId    String  @unique
  status    String // "Pending", "Verified", "Rejected", "In Review"
  level     Int     @default(1)
  documents Json? // URLs for idFront, idBack, selfie
  docType   String? // "National ID", "Passport", etc.
  riskScore String  @default("Low")
  notes     String?

  user User @relation(fields: [userId], references: [id])

  submittedAt DateTime  @default(now())
  verifiedAt  DateTime?

  @@map("kyc_records")
}

model OAuthConsent {
  userId    String
  clientId  String
  scopes    String[]
  grantedAt DateTime @default(now())

  user   User        @relation(fields: [userId], references: [id])
  client OAuthClient @relation(fields: [clientId], references: [id])

  @@id([userId, clientId])
  @@map("oauth_consents")
}

model AuditLog {
  id        String  @id @default(uuid())
  userId    String?
  action    String // "login", "password_change", "update_profile"
  details   Json?
  ipAddress String?

  // Enhanced Audit Details
  severity  String  @default("info") // "info", "warning", "critical"
  actorName String? // Snapshot of actor name

  user         User?         @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// -----------------------------------------------------------------------------
// Parental Control Module
// -----------------------------------------------------------------------------

model ChildProfile {
  id                   String    @id @default(uuid())
  parentId             String
  name                 String
  dob                  DateTime
  school               String?
  grade                String?
  country              String?
  status               String    @default("Active") // "Active", "Paused"
  guardianVerified     Boolean   @default(false)
  consentVersion       String?
  consentAt            DateTime?
  template             String    @default("Custom")
  guardianRelationship String    @default("Parent")

  // Wallet / Spending
  currency                       String   @default("UGX")
  dailyLimit                     Decimal  @default(0) @db.Decimal(15, 2)
  weeklyLimit                    Decimal  @default(0) @db.Decimal(15, 2)
  requireApprovalAbove           Decimal  @default(0) @db.Decimal(15, 2)
  requireApprovalForAllPurchases Boolean  @default(true)
  allowWithdrawals               Boolean  @default(false)
  allowPeerTransfers             Boolean  @default(false)
  allowSavedCards                Boolean  @default(false)
  categoryBlocks                 String[]
  sellerWhitelist                String[]

  // Communication
  allowTeacherMentorChat Boolean @default(true)
  allowAttachments       Boolean @default(false)
  allowVoiceCalls        Boolean @default(false)
  allowUnknownContacts   Boolean @default(false)

  // Notifications
  guardianChannels Json? // { Email: boolean, SMS: boolean, WhatsApp: boolean }

  // Screen time / Schedule
  preset           String  @default("Custom")
  bedtimeLock      Boolean @default(true)
  dailyWindowStart String? // HH:mm
  dailyWindowEnd   String? // HH:mm

  // Curfew
  curfewEnabled     Boolean @default(false)
  curfewStart       String?
  curfewEnd         String?
  curfewHardLock    Boolean @default(true)
  curfewAllowSchool Boolean @default(true)

  // Geofences
  geofencesEnabled Boolean @default(false)
  geofencesAlerts  Boolean @default(true)
  homeAddress      String?
  homeRadius       Float?
  schoolAddress    String?
  schoolRadius     Float?

  // Apps
  apps Json? // Record<AppKey, boolean>

  // Charging
  chargingEnabled     Boolean  @default(false)
  dailyKwhCap         Float?
  sessionKwhCap       Float?
  reqApprovalAboveKwh Float?
  allowedStations     String[]

  // Privacy
  locationSharing Boolean @default(false)
  publicProfile   Boolean @default(false)
  marketingOptOut Boolean @default(true)

  parent     User               @relation("GuardianToChildren", fields: [parentId], references: [id])
  approvals  ParentalApproval[]
  activities ParentalActivity[]

  // Real Linking Support
  inviteCode String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parental_child_profiles")
}

model Household {
  id           String  @id @default(uuid())
  ownerId      String  @unique
  name         String?
  approvalMode String  @default("Any guardian") // "Any guardian", "Both guardians"

  owner   User              @relation("HouseholdOwner", fields: [ownerId], references: [id])
  members HouseholdMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parental_households")
}

model HouseholdMember {
  id          String  @id @default(uuid())
  householdId String
  userId      String? // If they are already a user
  name        String
  role        String // "Guardian", "Co-guardian", "Emergency contact"
  email       String?
  phone       String?
  status      String  @default("Active") // "Active", "Pending"
  channels    Json? // Notification preferences
  isPrimary   Boolean @default(false)

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parental_household_members")
}

model ParentalApproval {
  id       String   @id @default(uuid())
  childId  String
  title    String
  amount   Decimal? @db.Decimal(15, 2)
  currency String?
  app      String
  vendor   String?
  kind     String // "Purchase", "Ride", "Trip", "Service Booking"
  reason   String?
  details  String?
  status   String   @default("Pending") // "Pending", "Approved", "Declined"
  
  // Multi-guardian support
  votes    String[] // List of Guardian IDs who approved

  at       DateTime @default(now())

  child ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@map("parental_approvals")
}

model ParentalActivity {
  id       String   @id @default(uuid())
  childId  String
  kind     String
  summary  String
  severity String   @default("info")
  at       DateTime @default(now())

  child ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@map("parental_activities")
}

// -----------------------------------------------------------------------------
// Notifications
// -----------------------------------------------------------------------------

model Notification {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String
  type        String // SECURITY, INFO, SUCCESS, WARNING
  read        Boolean  @default(false)
  data        Json?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// OIDC Persistence (Sessions, Interactions, Grants)
model OidcPayload {
  id        String   @id
  type      String   // 'Session', 'AccessToken', etc.
  payload   Json
  grantId   String?
  userCode  String?
  uid       String?  @unique
  expiresAt DateTime?
  consumedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([type])
  @@index([grantId])
}
